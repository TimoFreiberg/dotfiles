---
id: 785b4cad
title: "[P2] LSP extension: module-level cwd only updated on lsp tool execution"
tags: [lsp, p2, bug]
status: open
created_at: "2026-02-15T21:59:47.185Z"
---

**File:** `agents/extensions/lsp/index.ts:23,323,421`

The `tool_result` handler at line 421 resolves file paths against `cwd`, but `cwd` is set to `process.cwd()` at load time and only refreshed inside `execute()`. If the user does a write/edit before ever calling the `lsp` tool, and `ctx.cwd` differs from `process.cwd()`, the refresh will resolve the wrong path.

**Fix:** Read `cwd` from the event's context if available, or use `process.cwd()` at call time rather than caching it.

---
id: ce873568
title: "LSP: Race condition in `getClient` can spawn duplicate servers"
tags: [bug, lsp]
status: open
created_at: "2026-02-18T19:12:59.951Z"
assigned_to_session: "7c80a79f-ae2d-49da-b31c-6a7c7f310786"
---

**Bug** â€” If two concurrent tool calls target the same server, both see `existing?.isRunning()` as `false` and both call `client.start()`, spawning duplicate server processes. Only the last one is stored in the `clients` map; the other leaks.

**Fix:** Use a pending-promise pattern in `getClient`:
```typescript
const starting = new Map<string, Promise<LspClient>>();

async function getClient(serverName, serverConfig, projectRoot) {
  const existing = clients.get(serverName);
  if (existing?.isRunning()) return existing;

  const inflight = starting.get(serverName);
  if (inflight) return inflight;

  const promise = (async () => {
    const client = new LspClient();
    // ... setup ...
    await client.start({ ... });
    clients.set(serverName, client);
    starting.delete(serverName);
    return client;
  })();

  starting.set(serverName, promise);
  return promise;
}
```

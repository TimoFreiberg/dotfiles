---
id: 33ed0d9d
title: "LSP: Handle server-to-client requests (registerCapability, etc.)"
tags: [important, lsp]
status: done
created_at: "2026-02-18T19:13:05.962Z"
---

## Problem

The `onData` handler in `client.ts` only processes responses to pending requests. LSP servers can send **requests** to the client (messages with both `id` and `method`) that expect a response. Not responding can cause the server to hang or degrade.

Known server-to-client requests: `client/registerCapability`, `window/workDoneProgress/create`, `workspace/configuration`.

## Changes

All changes in `agents/extensions/lsp/client.ts`, in the `onData` method after the existing `pending` check.

### 1. Detect incoming server requests

A server-to-client request has both `id` and `method` and is **not** in `this.pending`. Add a branch for this case.

### 2. Respond per method

- **`workspace/configuration`**: The server sends `params.items` (an array of config queries) and expects an array of the same length back. Return an array of `null`s (`params.items.map(() => null)`) — this tells the server "no config overrides" without breaking the protocol shape.
- **All other requests** (`client/registerCapability`, `window/workDoneProgress/create`, unknown methods): respond with `{ jsonrpc: "2.0", id: msg.id, result: null }`.

### 3. Log incoming requests

Emit via `this.emit("log", ...)` with the method name and request id, consistent with how stderr is already logged.

### 4. Out of scope

- **Do not** track dynamically registered capabilities — ack and ignore.
- **Do not** log or handle server-to-client **notifications** (messages with `method` but no `id`) — keep output non-spammy.
- **No changes to `index.ts`** — log events from the client are already wired up (currently suppressed by the listener).
- **No `MethodNotFound` errors** — stay permissive with `result: null` for unknown requests.

## Acceptance criteria

- Server-to-client requests get a valid JSON-RPC response (no hangs).
- `workspace/configuration` returns a correctly-shaped array of nulls.
- Incoming requests are logged via the `log` event.
- Server-to-client notifications remain silently ignored.

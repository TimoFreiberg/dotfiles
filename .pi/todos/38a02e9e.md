---
id: 38a02e9e
title: "LSP: Document version always 1 in `refreshDocument`"
tags: [minor, lsp]
status: open
created_at: "2026-02-18T19:13:31.596Z"
---

**Minor** â€” In `client.ts`, `refreshDocument` closes and reopens a document with version always set to 1 (via `ensureOpen`). Some LSP servers track document versions across open/close cycles and may behave oddly when the version doesn't increment.

**Fix:** Add a per-document version counter:
```typescript
private docVersions = new Map<string, number>();

async ensureOpen(filePath, content, languageId) {
  const uri = `file://${filePath}`;
  if (this.openDocuments.has(uri)) return;
  const version = (this.docVersions.get(uri) ?? 0) + 1;
  this.docVersions.set(uri, version);
  this.notify("textDocument/didOpen", {
    textDocument: { uri, languageId, version, text: content },
  });
  this.openDocuments.add(uri);
}
```
